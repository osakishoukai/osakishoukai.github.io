---
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";
import { Icon } from "astro-icon/components";
import Breadcrumbs from "@/components/ui/Breadcrumbs.astro";

// イベントデータを読み込む
import eventsData from "@/data/events.json";

export async function getStaticPaths() {
  const events = [...(eventsData.events || [])].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
  
  return events.map((event, index) => {
    const prevEvent = index > 0 ? events[index - 1] : null;
    const nextEvent = index < events.length - 1 ? events[index + 1] : null;
    
    return {
      params: { date: event.date },
      props: { event, prevEvent, nextEvent }
    };
  });
}

const { event, prevEvent, nextEvent } = Astro.props;

// 日付フォーマット関数
function formatDate(dateStr) {
  const date = new Date(dateStr);
  const weekdays = ["日", "月", "火", "水", "木", "金", "土"];
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const weekday = weekdays[date.getDay()];
  return `${year}年${month}月${day}日(${weekday})`;
}

// Twitter URLからIDを抽出 (x.com / twitter.com 両対応)
function getTwitterId(url) {
  const match = url.match(/(?:twitter\.com|x\.com)\/.+\/status\/(\d+)/);
  return match ? match[1] : null;
}

const formattedDate = formatDate(event.date);
const hasImages = event.images && event.images.length > 0;
const hasUrls = event.urls && event.urls.length > 0;
const hasSummary = event.summary && event.summary.trim().length > 0;
---

<Layout title={`${formattedDate} 開催記録 - KemonoBarずんどこ`}>
  <Container>
    <!-- パンくず & 前後の開催 -->
    <div class="top-nav">
      <Breadcrumbs items={[
        { label: "イベント", href: "/events" },
        { label: "開催記録", href: "/events/archive" },
        { label: formattedDate }
      ]} />
    </div>

    <!-- ヘッダー -->
    <div class="event-header">
      <div class="header-nav-wrapper">
        {prevEvent ? (
          <a href={`/events/archive/${prevEvent.date}`} class="header-nav-link prev" title="前の開催へ">
            <Icon name="mdi:chevron-left" class="header-nav-icon" />
          </a>
        ) : <div class="header-nav-spacer" />}

        <h1 class="event-title">
          <Icon name="mdi:calendar-star" class="title-icon" />
          {formattedDate}
        </h1>

        {nextEvent ? (
          <a href={`/events/archive/${nextEvent.date}`} class="header-nav-link next" title="次の開催へ">
            <Icon name="mdi:chevron-right" class="header-nav-icon" />
          </a>
        ) : <div class="header-nav-spacer" />}
      </div>

      <div class="event-meta">
        <div class="meta-item">
          <Icon name="mdi:account-group" class="meta-icon" />
          <span class="meta-label">参加者</span>
          <span class="meta-value">{event.participants}人</span>
        </div>
        <div class="meta-item">
          <Icon name="mdi:account-supervisor" class="meta-icon" />
          <span class="meta-label">スタッフ</span>
          <span class="meta-value">{event.staff.length}名</span>
        </div>
      </div>
    </div>

    <!-- スタッフ一覧 -->
    <div class="staff-section">
      <h2 class="section-title">
        <Icon name="mdi:account-tie" class="section-icon" />
        参加スタッフ
      </h2>
      <div class="staff-list">
        {event.staff.map(staffName => (
          <div class="staff-badge">{staffName}</div>
        ))}
      </div>
    </div>

    <!-- 総括 -->
    {hasSummary && (
      <div class="summary-section">
        <h2 class="section-title">
          <Icon name="mdi:note-text" class="section-icon" />
          おおさきくんのメモ
        </h2>
        <div class="summary-content">
          <p>{event.summary}</p>
        </div>
      </div>
    )}

    <!-- スクリーンショット -->
    {hasImages && (
      <div class="screenshots-section">
        <h2 class="section-title">
          <Icon name="mdi:camera" class="section-icon" />
          スクリーンショット (クリックで拡大)
        </h2>
        <div class:list={["screenshots-grid", event.images.length === 1 && "is-single"]}>
          {event.images.map((imgPath, index) => {
            const imageUrl = `/images/${imgPath.replace(/\\/g, '/')}`;
            return (
              <button class="lightbox-trigger screenshot-item" data-image={imageUrl} data-index={index}>
                <img src={imageUrl} alt="イベントの様子" class="screenshot-image" />
              </button>
            );
          })}
        </div>
      </div>
    )}

    <!-- SNS投稿 -->
    {hasUrls && (
      <div class="social-section">
        <h2 class="section-title">
           <Icon name="mdi:twitter" class="section-icon" />
          SNS投稿
        </h2>
        <div class="social-embeds">
          {event.urls.map(url => {
            const twitterId = getTwitterId(url);
            if (twitterId) {
              const displayUrl = url.replace('x.com', 'twitter.com');
              return (
                <div class="tweet-container">
                  <blockquote class="twitter-tweet" data-lang="ja" data-theme="light" data-dnt="true">
                    <p lang="ja" dir="ltr">開催記録の投稿です。</p>
                    &mdash; 大崎商会 (@osaki_vrc) <a href={displayUrl}>{formattedDate}</a>
                  </blockquote>
                </div>
              );
            } else {
              return (
                <a href={url} target="_blank" rel="noopener noreferrer" class="social-link">
                  <Icon name="mdi:link-variant" class="link-icon" />
                  {url}
                </a>
              );
            }
          })}
        </div>
      </div>
    )}

    <!-- ナビゲーション -->
    <div class="navigation-section">
      <div class="bottom-nav">
        {prevEvent ? (
          <a href={`/events/archive/${prevEvent.date}`} class="nav-button prev">
            <Icon name="mdi:arrow-left" class="btn-icon" />
            前の開催
          </a>
        ) : <div />}
        
        <a href="/events/archive" class="back-button">
          一覧に戻る
        </a>

        {nextEvent ? (
          <a href={`/events/archive/${nextEvent.date}`} class="nav-button next">
            次の開催
            <Icon name="mdi:arrow-right" class="btn-icon" />
          </a>
        ) : <div />}
      </div>
    </div>
  </Container>

  <!-- Lightbox Dialog -->
  <dialog id="image-dialog" class="lightbox">
    <img id="lightbox-img" src="" alt="拡大画像" />
  </dialog>
</Layout>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<script is:inline>
  // Twitter X widgets loading helper
  function initTwitterWidgets() {
    if (window.twttr && window.twttr.widgets) {
      window.twttr.widgets.load();
    }
  }

  // Lightbox functions
  const dialog = document.getElementById('image-dialog');
  const lightboxImg = document.getElementById('lightbox-img');
  const triggers = document.querySelectorAll('.lightbox-trigger');
  
  // サムネイルクリックで開く
  triggers.forEach(trigger => {
    trigger.addEventListener('click', () => {
      const imageUrl = trigger.getAttribute('data-image');
      if (dialog && lightboxImg && imageUrl) {
        lightboxImg.src = imageUrl;
        dialog.showModal();
        document.body.style.overflow = 'hidden'; // 背景スクロールをブロック
      }
    });
  });
  
  // どこをクリックしても閉じる
  if (dialog) {
    dialog.addEventListener('click', () => {
      dialog.close();
      document.body.style.overflow = ''; // スクロールを復元
    });
  }

  // 1. 通常のロード完了時
  window.addEventListener('load', initTwitterWidgets);

  // 2. Astroのページ遷移完了時
  document.addEventListener('astro:page-load', initTwitterWidgets);
  document.addEventListener('astro:after-swap', initTwitterWidgets);

  // 3. スクリプトの読み込み遅延対策（ポーリング）
  let pollCount = 0;
  const poll = setInterval(() => {
    pollCount++;
    if (window.twttr && window.twttr.widgets) {
      initTwitterWidgets();
      clearInterval(poll);
    }
    if (pollCount > 20) clearInterval(poll); // 最大10秒待機
  }, 500);


</script>

<style is:global>
  /* ダークテーマ対応 */
  :root {
    --event-card-bg: #ffffff;
    --event-section-bg: #ffffff;
    --event-text-color: var(--sub-color);
  }

  [data-theme='dark'] {
    --event-card-bg: #1a1a1a;
    --event-section-bg: #1a1a1a;
    --event-text-color: #eeeeee;
  }

  /* Lightbox Styles */
  /* ダイアログが開いていない時は確実に非表示 */
  .lightbox:not([open]) {
    display: none;
  }

  .lightbox {
    width: 100vw;
    height: 100vh;
    max-width: 100vw;
    max-height: 100vh;
    border: none;
    padding: 0;
    margin: 0;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    inset: 0;
    position: fixed;
  }

  .lightbox::backdrop {
    background-color: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(4px);
    cursor: pointer;
  }

  @media (prefers-reduced-motion: no-preference) {
    .lightbox[open] {
      animation: fadeIn 0.25s ease-out;
    }
    
    .lightbox[open]::backdrop {
      animation: fadeIn 0.25s ease-out;
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .lightbox img {
    max-width: 100vw;
    max-height: 100vh;
    width: auto;
    height: auto;
    display: block;
    margin: auto;
    object-fit: contain;
    pointer-events: none;
  }
</style>

<style>
  /* ページ上部ナビゲーション */
  .top-nav {
    margin-bottom: 2rem;
  }

  /* ヘッダー */
  .event-header {
    background: linear-gradient(135deg, white 0%, var(--bg-color) 100%);
    border: 3px solid var(--main-color);
    border-radius: 2rem;
    padding: 3rem;
    margin-bottom: 2rem;
    text-align: center;
  }

  .header-nav-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .header-nav-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3.5rem;
    height: 3.5rem;
    background: white;
    border: 3px solid var(--main-color);
    border-radius: 50%;
    color: var(--main-color);
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .header-nav-link:hover {
    background: var(--main-color);
    color: white;
    transform: scale(1.1);
  }

  .header-nav-icon {
    width: 2rem;
    height: 2rem;
  }

  .header-nav-spacer {
    width: 3.5rem;
    flex-shrink: 0;
  }

  .event-title {
    font-size: clamp(1.8rem, 4vw, 3rem);
    font-weight: 900;
    color: var(--main-color);
    margin-bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .title-icon {
    width: 3rem;
    height: 3rem;
  }

  .event-meta {
    display: flex;
    justify-content: center;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: white;
    padding: 0.75rem 1.5rem;
    border-radius: 2rem;
    border: 2px solid var(--main-color);
  }

  .meta-icon {
    width: 1.5rem;
    height: 1.5rem;
    color: var(--main-color);
  }

  .meta-label {
    font-size: 0.875rem;
    color: var(--sub-color);
    font-weight: 700;
  }

  .meta-value {
    font-size: 1.25rem;
    font-weight: 900;
    color: var(--main-color);
  }

  /* セクション共通 */
  .staff-section,
  .summary-section,
  .screenshots-section,
  .social-section {
    background: var(--event-section-bg);
    border: 3px solid var(--main-color);
    border-radius: 1.5rem;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  .section-title {
    margin-bottom: 0.4rem;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .section-icon {
    width: 2rem;
    height: 2rem;
    color: var(--main-color);
  }

  /* スタッフリスト */
  .staff-list {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .staff-badge {
    background: var(--bg-color);
    border: 2px solid var(--main-color);
    padding: 0.75rem 1.5rem;
    border-radius: 2rem;
    font-weight: 900;
    color: var(--sub-color);
    font-size: 1rem;
  }

  /* 総括 */
  .summary-content {
    background: transparent;
    padding: 0 0.5rem;
    line-height: 1.5;
    font-size: 0.95rem;
    color: var(--sub-color);
    white-space: pre-wrap; /* 改行を反映 */
  }

  .summary-content p {
    margin: 0;
  }

  /* スクリーンショット */
  .screenshots-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
  }

  .screenshots-grid.is-single {
    grid-template-columns: 1fr;
    max-width: 90%;
    margin: 0 auto;
  }

  .screenshot-item {
    position: relative;
    border-radius: 1rem;
    overflow: hidden;
    border: 3px solid var(--main-color);
    background: var(--bg-color);
    cursor: zoom-in;
    aspect-ratio: 16/9; /* アスペクト比を固定 */
    padding: 0;
    width: 100%;
  }

  .screenshot-image {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover; /* はみ出しをカットしてフィットさせる */
    transition: transform 0.3s ease;
  }

  .screenshot-item:hover .screenshot-image {
    transform: scale(1.05);
  }

  /* SNS投稿 */
  .social-embeds {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    max-width: 550px;
    margin: 0 auto;
  }

  .tweet-container {
    width: 100%;
    display: flex;
    justify-content: center;
  }

  .social-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    background: var(--bg-color);
    border: 2px solid var(--main-color);
    border-radius: 1rem;
    color: var(--main-color);
    text-decoration: none;
    font-weight: 700;
    transition: all 0.3s ease;
  }

  .social-link:hover {
    background: var(--main-color);
    color: white;
  }

  .link-icon {
    width: 1.5rem;
    height: 1.5rem;
  }

  /* ページ下部ナビゲーション */
  .navigation-section {
    margin-top: 3rem;
  }

  .bottom-nav {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 1.5rem;
    align-items: center;
  }

  .nav-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.8rem 1.5rem;
    background: white;
    border: 2px solid var(--main-color);
    border-radius: 2rem;
    color: var(--main-color);
    text-decoration: none;
    font-weight: 900;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .nav-button:hover {
    background: var(--main-color);
    color: white;
  }

  .nav-button.prev { justify-self: start; }
  .nav-button.next { justify-self: end; }

  .back-button {
    display: inline-flex;
    align-items: center;
    padding: 0.8rem 2rem;
    background: var(--bg-color);
    border: 2px solid var(--main-color);
    border-radius: 2rem;
    color: var(--sub-color);
    text-decoration: none;
    font-weight: 900;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    justify-self: center;
  }

  .back-button:hover {
    filter: brightness(0.9);
    transform: translateY(-2px);
  }

  .btn-icon {
    width: 1.25rem;
    height: 1.25rem;
  }

  @media (max-width: 768px) {
    .event-header {
      padding: 2rem 1.5rem;
    }

    .screenshots-grid {
      grid-template-columns: 1fr;
    }

    .bottom-nav {
      grid-template-columns: 1fr 1fr;
      row-gap: 1.5rem;
    }

    .back-button {
      grid-column: span 2;
      order: 3;
    }

    .staff-section,
    .summary-section,
    .screenshots-section,
    .social-section {
      padding: 1.5rem;
    }
  }
</style>
