---
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";
import { Icon } from "astro-icon/components";
import Breadcrumbs from "@/components/ui/Breadcrumbs.astro";

// 商品データを読み込む
import productsData from "@/data/products.json";
const products = productsData.products || [];

// タグから重複を除いてカテゴリを生成
const allTags = new Set<string>();
products.forEach(product => {
  product.tags?.forEach(tag => allTags.add(tag));
});
const categories = ["すべて", ...Array.from(allTags)];
---

<Layout 
  title="商品一覧"
  description="VRChat向け軽量・Quest対応ワールドアセット一覧。焼き鳥、おつまみ、お好み焼きなど居酒屋風アセットから便利なワールドギミックまで。すべて「KemonoBarずんどこ」で実証済み。"
  keywords={["VRChat アセット", "ワールドアセット", "Quest対応", "軽量", "食べ物", "居酒屋", "焼き鳥", "おつまみ", "Booth", "大崎商会"]}
>
  <Container>
    <Breadcrumbs items={[{ label: "商品一覧" }]} />
    
    <div class="hero-section">
      <div class="hero-content-wrapper">
        <div class="hero-text-box">
          <h1 class="hero-title">
            商品一覧
          </h1>
          <p class="hero-intro">
            「みんなVRでたのしくくらそう」を支える、<br />
            すべて実際のイベント「KemonoBarずんどこ」で実証済みの軽量アセットです。
          </p>
        </div>
      </div>
    </div>
  </Container>

  <Container>
    <!-- Filter and Search (Collapsible) -->
    <div class="filter-section">
      <button class="filter-toggle" id="filterToggle">
        <Icon name="mdi:filter-variant" class="toggle-icon" />
        <span>カテゴリ・検索で絞り込む</span>
        <Icon name="mdi:chevron-down" class="chevron-icon" />
      </button>
      
      <div class="filter-content" id="filterContent">
        <div class="filter-tags">
          {categories.map((category) => (
            <button class={`filter-tag ${category === "すべて" ? "active" : ""}`}>
              {category}
            </button>
          ))}
        </div>
        <div class="search-box">
          <Icon name="mdi:magnify" class="search-icon" />
          <input type="text" placeholder="キーワードで検索" class="search-input" />
        </div>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="products-grid">
      {products.map((product) => (
        <div class="product-card" data-tags={JSON.stringify(product.tags)}>
          <a href={`/products/${product.id}`} class="product-card-link">
            <div class="product-image">
              {product.main_image ? (
                <img src={product.main_image} alt={product.name} class="product-thumbnail" />
              ) : (
                <div class="placeholder-image">
                  <Icon name="mdi:package-variant" class="placeholder-icon" />
                </div>
              )}
            </div>
            <div class="product-info">
              <h3 class="product-name">{product.name}</h3>
            </div>
          </a>
          <div class="product-actions">
            <a href={`/products/${product.id}`} class="btn-detail">詳細を見る</a>
            {product.booth_url && (
              <a href={product.booth_url} target="_blank" rel="noopener noreferrer" class="action-icon-btn" title="Boothで購入" onclick="event.stopPropagation()">
                <img src="/images/booth-icon.svg" alt="Booth" class="action-icon-img booth-icon" />
              </a>
            )}
            {product.sample_world_url && (
              <a href={product.sample_world_url} target="_blank" rel="noopener noreferrer" class="action-icon-btn world-btn" title="サンプルワールド" onclick="event.stopPropagation()">
                <img src="/images/world.svg" alt="World" class="action-icon-img" />
              </a>
            )}
          </div>
        </div>
      ))}
    </div>

    <!-- CTA Section -->
    <div class="cta-section">
      <h2 class="cta-title">商品に関するご質問・ご要望</h2>
      <p class="cta-description">
        導入方法、カスタマイズ、不具合などお気軽にお問い合わせください。
      </p>
      <a href="/support#contact" class="cta-button">
        <Icon name="mdi:email" class="cta-icon" />
        お問い合わせフォーム
      </a>
    </div>
  </Container>
</Layout>

<script>
  // Filter logic
  document.addEventListener('DOMContentLoaded', () => {
    // Filter toggle functionality
    const filterToggle = document.getElementById('filterToggle');
    const filterContent = document.getElementById('filterContent');
    const chevronIcon = filterToggle?.querySelector('.chevron-icon');
    
    if (filterToggle && filterContent) {
      filterToggle.addEventListener('click', () => {
        const isOpen = filterContent.classList.contains('open');
        
        if (isOpen) {
          filterContent.classList.remove('open');
          chevronIcon?.classList.remove('rotate');
        } else {
          filterContent.classList.add('open');
          chevronIcon?.classList.add('rotate');
        }
      });
    }

    // Filter and search functionality
    const filterTags = document.querySelectorAll('.filter-tag');
    const searchInput = document.querySelector('.search-input') as HTMLInputElement;
    const productCards = document.querySelectorAll('.product-card');

    let currentCategory = 'すべて';
    let currentSearch = '';

    function filterProducts() {
      productCards.forEach((card) => {
        const productCard = card as HTMLElement;
        const tags = JSON.parse(productCard.dataset.tags || '[]');
        const name = productCard.querySelector('.product-name')?.textContent || '';
        
        const matchesCategory = currentCategory === 'すべて' || tags.includes(currentCategory);
        const matchesSearch = name.toLowerCase().includes(currentSearch.toLowerCase());

        if (matchesCategory && matchesSearch) {
          productCard.style.display = 'block';
        } else {
          productCard.style.display = 'none';
        }
      });
    }

    filterTags.forEach((tag) => {
      tag.addEventListener('click', () => {
        // Update active class
        filterTags.forEach(t => t.classList.remove('active'));
        tag.classList.add('active');

        // Update current category
        currentCategory = tag.textContent?.trim() || 'すべて';
        filterProducts();
      });
    });

    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement;
        currentSearch = target.value;
        filterProducts();
      });
    }
  });
</script>

<style>
  /* Hero Section */
  .hero-section {
    padding: 3rem 1.5rem;
    position: relative;
    background-image: linear-gradient(rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0.45)), url('/images/products-hero.webp');
    background-size: cover;
    background-position: center;
    border-radius: 2rem;
    overflow: hidden;
    margin-bottom: 3rem;
    border: 2px solid var(--main-color);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
  }

  .hero-content-wrapper {
    max-width: 800px;
    width: 100%;
    z-index: 10;
  }

  .hero-text-box {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    padding: 3rem;
    border-radius: 2rem;
    border: 2px solid var(--main-color);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    text-align: center;
  }

  .hero-title {
    font-size: clamp(2.5rem, 5vw, 3.5rem);
    font-weight: 900;
    line-height: 1.2;
    margin-bottom: 1.5rem;
    color: var(--main-color);
    text-shadow: 2px 2px 0px white, -1px -1px 0px white, 1px -1px 0px white, -1px 1px 0px white;
  }

  .hero-intro {
    font-size: clamp(1.1rem, 2vw, 1.25rem);
    color: var(--sub-color);
    line-height: 1.8;
    font-weight: 700;
  }

  @media (max-width: 768px) {
    .hero-section {
      padding: 2rem 1rem;
      min-height: 300px;
    }

    .hero-text-box {
      padding: 2rem;
    }
  }

  .page-description { font-size: clamp(1rem, 2vw, 1.25rem); color: var(--sub-color); line-height: 1.8; }
  
  /* Filter Section - Collapsible */
  .filter-section { margin-bottom: 3rem; }
  
  .filter-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    background: white;
    border: 2px solid var(--main-color);
    border-radius: 1rem;
    color: var(--sub-color);
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
  }
  
  .filter-toggle:hover {
    background: var(--bg-color);
    transform: translateY(-2px);
  }
  
  .toggle-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--main-color);
  }
  
  .chevron-icon {
    width: 1.25rem;
    height: 1.25rem;
    transition: transform 0.3s ease;
  }
  
  .chevron-icon.rotate {
    transform: rotate(180deg);
  }
  
  .filter-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  
  .filter-content.open {
    max-height: 1000px;
  }
  
  .filter-tags { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .filter-tag { padding: 0.5rem 1.25rem; border: 2px solid var(--main-color); border-radius: 2rem; background: white; color: var(--sub-color); font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
  .filter-tag:hover, .filter-tag.active { background: var(--main-color); color: white; }
  .search-box { position: relative; display: flex; align-items: center; }
  .search-icon { position: absolute; left: 1rem; width: 1.25rem; height: 1.25rem; color: var(--sub-color); opacity: 0.5; }
  .search-input { padding: 0.75rem 1rem 0.75rem 3rem; border: 2px solid var(--main-color); border-radius: 2rem; font-size: 1rem; min-width: 300px; background: white; color: var(--sub-color); }
  
  .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; margin-bottom: 4rem; }
  
  .product-card { 
    background: white; 
    border-radius: 2rem; 
    border: 3px solid var(--main-color); 
    overflow: hidden; 
    transition: all 0.3s ease;
    position: relative;
  }
  .product-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
  
  .product-card-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }
  
  .product-external-links {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.5rem;
    z-index: 10;
  }
  
  .booth-icon-link,
  .world-icon-link {
    display: block;
    transition: all 0.3s ease;
  }
  
  .booth-icon-link:hover,
  .world-icon-link:hover {
    transform: scale(1.1);
  }
  
  .external-icon {
    width: 32px;
    height: 32px;
    display: block;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
  }
  
  /* 正方形のサムネイル */
  .product-image { 
    position: relative; 
    width: 100%; 
    padding-bottom: 100%; /* 1:1のアスペクト比 */
    background: var(--bg-color); 
    border-bottom: 3px solid var(--main-color);
    overflow: hidden;
  }
  
  .product-thumbnail {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .placeholder-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .placeholder-icon { width: 6rem; height: 6rem; color: var(--main-color); opacity: 0.3; }
  
  .product-info { padding: 1rem 1rem 1rem 1rem; }
  .product-name { 
    font-size: 1rem; 
    font-weight: 700; 
    margin-bottom: 0.5rem; 
    color: var(--sub-color);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    min-height: 2.8rem;
  }
  
  .product-price {
    font-size: 1.5rem;
    font-weight: 900;
    color: var(--main-color);
    margin-bottom: 0.5rem;
  }
  
  .product-date {
    font-size: 0.875rem;
    color: var(--sub-color);
    opacity: 0.7;
    margin-bottom: 1rem;
  }
  
  .product-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }
  
  .product-tag {
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    background: var(--bg-color);
    color: var(--sub-color);
    border-radius: 1rem;
    font-weight: 700;
  }
  
  .product-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    padding: 0 1rem 1rem 1rem;
    height: 40px; /* コンテナの高さを確保 */
  }
  
  .btn-detail {
    flex: 1;
    height: 40px;
    line-height: 40px;
    background: var(--main-color);
    color: white;
    text-align: center;
    border-radius: 0.5rem;
    font-weight: 700;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    text-decoration: none;
    display: block;
    padding: 0; /* paddingをなくしてheightのみで制御 */
  }
  
  .product-card:hover .btn-detail {
    background: var(--sub-color);
  }
  
  .action-icon-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 0.5rem;
    background: transparent;
    border: none;
    transition: all 0.3s ease;
    flex-shrink: 0;
    padding: 0;
    cursor: pointer;
    text-decoration: none;
    overflow: hidden; /* 角丸を適用するため */
  }
  
  .action-icon-btn:hover {
    transform: scale(1.1);
  }
  
  .action-icon-btn.world-btn {
    background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
  }
  
  .action-icon-img {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
  }

  .world-btn .action-icon-img {
    width: 24px;
    height: 24px;
    object-fit: contain;
  }
  
  /* Boothアイコン特有の調整（元の画像が角丸付きの正方形なのでそのまま100%表示） */
  .booth-icon {
    width: 40px;
    height: 40px;
    border-radius: 0.5rem;
  }

  
  .cta-section { background: white; color: var(--sub-color); padding: 4rem; border-radius: 2rem; text-align: center; margin-bottom: 4rem; border: 2px solid #e2e8f0; }
  .cta-title { font-size: 2rem; font-weight: 900; margin-bottom: 1rem; color: var(--main-color); }
  .cta-button { display: inline-flex; align-items: center; gap: 0.75rem; background: var(--main-color); color: white; padding: 1rem 2.5rem; border-radius: 3rem; font-weight: 900; text-decoration: none; margin-top: 2rem; transition: all 0.3s ease; }
  .cta-button:hover { background: var(--sub-color); transform: translateY(-2px); }
  
  @media (max-width: 768px) { 
    .filter-section { flex-direction: column; align-items: stretch; } 
    .search-input { min-width: auto; }
    .products-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
  }
</style>